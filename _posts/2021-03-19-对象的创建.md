---
layout:     post
title:      对象的创建
subtitle:   对象
date:       2021-03-19
author:     pengfeng
header-img: img/post-bg-map.jpg
catalog: true
tags:
    - java
    - 对象
---

## 一、对象的创建过程

### 1、判断这个类是否已经被类加载器加载。

当Java虚拟机遇到new关键字指令，会先通过指令参数判断元空间中是否有对应类的符号引用。并通过这个引用判断类是否被创建过。如果没有，那就通过类加载器加载这个类。

### 2、为这个对象分配内存。

当类执行完创建过程并通过检查后，jvm开始为这个对象分配内存，对象所需内存的大小在类加载的时候就已经能够确定了。 分配内存有两种，**指针碰撞**和**空闲列表**，这个分配内存是根据内存是否规整来判断的，如何判断内存是否规整呢？根据GC收集算法。例如：**标记清楚算法**--不规整、 **标记整理算法**--规整。多个线程并发创建对象分配内存时可能出现线程不安全的情况，这个时候虚拟机使用CAS配合失败重试的方式来保证原子性。还有一种方式是为每个线程分配一个空间，有线程需要创建对象的时候在线程内部分配的缓冲空间中创建，可以保证线程安全。

### 3、将分配的内存空间初始化值。

一些属性赋默认值，这样保证对象直接可用。

### 4、设置对象元数据信息、HashCode、GC分代年龄、设置对像头，是否使用偏向锁等等。

这属于对象的额外存储信息。

### 5、执行构造参数，调用init方法完成对象的创建。

## 二、对象的结构

### 1、对象头

#### 1.1、存储对象本身的运行时数据（MarkWord）
哈希码（HashCode）、GC分代年龄、锁状态标志、线程持有的锁、偏向线程ID、偏向时间戳等。

#### 1.2、类型指针
对象实例指向其类元数据的指针，Java虚拟机就是通过这个指针来确定该对象是哪个类的实例。但是不是所有的虚拟机实现都保留类型指针，也即想要获取对象的元数据不一定非得通过对象本身。
注意：数组对象的对象头里需要存储数组的长度。因为普通Java对象只需通过对象的元数据就能知道对象的大小，但是数组对象长度如果是不确定的就没法通过对象的元信息去推测数组对象的长度。

### 2、实例数据
存储对象中真正有用的字段，也即各种类型的字段属性。无论是父类中继承的还是子类定义的都会被记录下来

### 3、对齐填充
这个部分不是必然存在的，虚拟机要求对象的起始地址必须是8字节的整数倍，假如对象实例数据没有对齐的话，这部分数据就会保证对齐填充。

## 三、对象的访问定位

创建对象目的就是为了使用对象，目前有两种主流的方式**句柄池**和**直接指针**。

#### 句柄池:

> 相当于在堆内存中维护一个句柄池，Java栈本地变量表中维护一个对象的句柄地址引用，通过这个句柄引用来查找这个对象。无论对象如何被移动（垃圾收集时移动对象是非常普遍的行为）只需要维护堆内存中句柄池中对象映射即可。查找效率相较于直接指针较慢。而Java栈本地变量表中维护的对象的句柄地址引用不需要被修改。

![](/img/jubingchi.png)

#### 直接指针：

> Java栈本地变量表中直接维护对象地址，对象地址移动时要维护栈中对象地址。但查询效率较高，二者各有各的优点。


![](/img/zhijiezhizhen.png)
